<style id="elaltillo-about-style" type="text/css">
    .about-paragraph .word {
        position: relative;
        overflow: hidden;
        margin: -.1em 0;
        display: inline-block;
    }

    .about-paragraph .word span {
        transform: translate(0, 100%);
        will-change: transform;
        display: block;
    }
</style>

<script id="elaltillo-about-script" type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        gsap.registerPlugin(ScrollTrigger);

        const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            direction: 'vertical',
            gestureDirection: 'vertical',
            smooth: true,
            mouseMultiplier: 1,
            smoothTouch: false,
            touchMultiplier: 2,
            infinite: false,
        });

        lenis.on('scroll', ScrollTrigger.update);

        function raf(time) {
            lenis.raf(time);
            ScrollTrigger.update();
            requestAnimationFrame(raf);
        }

        requestAnimationFrame(raf);

        // Retrieve the header height value from the CSS variable
        const headerHeightValue = updateHeaderHeight() || 100;

        // Set up media query handling with GSAP MatchMedia
        const mm = gsap.matchMedia();

        // About team
        const aboutTeam = document.querySelector(".about-main-photo");

        if (aboutTeam) {
            mm.add("(min-width: 769px)", () => {
                gsap.to(aboutTeam, {
                    scrollTrigger: {
                        trigger: aboutTeam,
                        pin: true,
                        pinSpacing: false,
                        start: `top ${headerHeightValue}px`,
                        end: "bottom center",
                        scrub: 1.5,
                    },
                    scale: "0.35",
                    opacity: 0,
                });
            });
        }

        // About paragraph
        const aboutParagraph = document.querySelector(".about-paragraph");

        if (aboutParagraph) {
            // Split the paragraph into individual words
            wrapWordsInSpan(aboutParagraph);

            aboutParagraph.querySelectorAll(".word").forEach((word) => {
                gsap.to(word.querySelector('span'), {
                    y: 0,
                    ease: "power4.out",
                    duration: 0.5,
                    scrollTrigger: {
                        trigger: word,
                        toggleActions: "play play reverse reverse",
                        start: "top 75%",
                        end: "+=1",
                        scrub: 1.5,
                        scroller: document.body
                    }
                });
            });
        }

        // Team members
        const teamContainers = document.querySelectorAll(".team-grid-container");

        if (teamContainers.length > 0) {
            teamContainers.forEach(teamContainer => {
                const teamContent = teamContainer.querySelector(".team-grid-content");

                if (teamContent) {
                    let teamTriggerInstance; // Stores the ScrollTrigger instance
                    let lastDocumentHeight = document.body.scrollHeight; // Stores the initial document height

                    function updateTeamTrigger() {
                        let scrollWidth = teamContent.scrollWidth - teamContainer.offsetWidth;
                        let containerHeight = teamContainer.offsetHeight;

                        if (scrollWidth > 0) {
                            if (teamTriggerInstance) {
                                teamTriggerInstance.kill(); // Removes the previous instance to prevent duplicates
                            }

                            teamTriggerInstance = ScrollTrigger.create({
                                trigger: teamContainer,
                                start: () => `top ${window.innerHeight / 2 - containerHeight / 2}px`,
                                end: () => `+=${scrollWidth}`,
                                scrub: 1.5,
                                pin: true,
                                anticipatePin: 1,
                                animation: gsap.to(teamContent, {
                                    x: () => -scrollWidth,
                                    duration: 3,
                                    ease: "none",
                                }),
                            });
                        } else {
                            // If the content is smaller than the wrapper, kill any ScrollTrigger instance to prevent scroll
                            if (teamTriggerInstance) {
                                teamTriggerInstance.kill();
                                teamTriggerInstance = null;
                            }
                        }
                    }

                    function checkDocumentHeightChange() {
                        const currentHeight = document.body.scrollHeight;

                        if (currentHeight !== lastDocumentHeight) {
                            console.log("Document height changed. Refreshing ScrollTrigger...");

                            setTimeout(() => {
                                if (teamTriggerInstance) {
                                    teamTriggerInstance.kill(); // Remove previous instance
                                }

                                updateTeamTrigger(); // Recalculate horizontal scroll

                                requestAnimationFrame(() => {
                                    ScrollTrigger.refresh();
                                });
                            }, 100); // Wait to avoid conflicts with browser rendering
                        }

                        lastDocumentHeight = currentHeight;
                    }

                    // Observe size changes in the container and content
                    const resizeObserver = new ResizeObserver(() => {
                        setTimeout(updateTeamTrigger, 100);
                    });

                    resizeObserver.observe(teamContainer);
                    resizeObserver.observe(teamContent);

                    // Observe changes in the accordions
                    const mutationObserver = new MutationObserver(() => {
                        checkDocumentHeightChange();
                    });

                    document.querySelectorAll(".accordion-item").forEach((accordion) => {
                        mutationObserver.observe(accordion, {
                            attributes: true,
                            attributeFilter: ["class"],
                            subtree: true,
                        });
                    });

                    updateTeamTrigger();
                }
            });
        }
    });
</script>